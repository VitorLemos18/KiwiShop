{% extends 'base.html' %}
{% block title %}Carrinho | Kiwi Imports{% endblock %}

{% block content %}

<style>
.cart-container {
    background: #fff;
    border-radius: 28px;
    padding: 50px;
    box-shadow: 0 30px 80px rgba(0,0,0,0.06);
}

.cart-item {
    background: #f8fafc;
    border-radius: 20px;
    padding: 25px;
    transition: .3s ease;
}

.cart-item:hover {
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
}

.cart-summary {
    background: #ffffff;
    border-radius: 24px;
    padding: 35px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.05);
}

.cart-summary.sticky-top {
    top: 120px;
}

.qty-input {
    max-width: 70px;
}

/* RESPONSIVIDADE */
@media (max-width: 992px) {
    .cart-container {
        padding: 25px;
    }

    .cart-summary.sticky-top {
        position: static !important;
        margin-top: 30px;
    }

    .cart-item .col-md-2,
    .cart-item .col-md-4 {
        text-align: center;
    }

    .cart-item .col-md-2.text-end {
        text-align: center !important;
        margin-top: 15px;
    }
}

@media (max-width: 576px) {
    .cart-item {
        padding: 15px;
    }

    .qty-input {
        max-width: 60px;
        margin: 0 auto;
    }

    .cart-summary {
        padding: 25px;
    }

    .cart-summary button,
    .cart-summary a {
        font-size: 0.9rem;
        padding: 10px 0;
    }

    .cart-item img {
        height: 80px;
    }
}
</style>

<div class="container my-5">

    {% if cart_items %}

    <!-- HEADER -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-5 gap-3">
        <h1 class="fw-bold display-6 mb-0">
            üõí Meu Carrinho
        </h1>
        <div class="text-end">
            <div class="h4 fw-bold text-primary mb-0">
                R$ {{ total|floatformat:2 }}
            </div>
            <small class="text-muted">
                {{ count }} item{{ count|pluralize }}
            </small>
        </div>
    </div>

    <div class="cart-container">
        <div class="row g-5">

            <!-- LISTA DE PRODUTOS -->
            <div class="col-lg-8">

                {% for item in cart_items %}
                <div class="cart-item mb-4">

                    <div class="row align-items-center g-3 g-md-4">

                        <!-- IMAGEM -->
                        <div class="col-4 col-md-2">
                            {% if item.product.image %}
                            <img src="{{ item.product.image }}"
                                 class="img-fluid rounded-4"
                                 style="height:100px; object-fit:cover;">
                            {% endif %}
                        </div>

                        <!-- INFO -->
                        <div class="col-8 col-md-4 text-center text-md-start">
                            <h6 class="fw-bold mb-1">
                                {{ item.product.name }}
                            </h6>
                            <small class="text-muted d-block">
                                {{ item.product.category.name }}
                            </small>
                            <small class="text-muted">
                                SKU: {{ item.product.id }}
                            </small>
                        </div>

                        <!-- PRE√áO UNIT√ÅRIO -->
                        <div class="col-6 col-md-2 text-center">
                            <div class="small text-muted">Pre√ßo</div>
                            <div class="fw-semibold">
                                R$ {{ item.product.price|floatformat:2 }}
                            </div>
                        </div>

                        <!-- QUANTIDADE -->
                        <div class="col-6 col-md-2 text-center mt-2 mt-md-0">
                            <div class="small text-muted mb-1">Qtd</div>
                            <input type="number"
                                   class="form-control text-center qty-input update-qty"
                                   value="{{ item.quantity }}"
                                   min="1"
                                   max="{{ item.product.stock }}"
                                   data-product="{{ item.product.id }}">
                            <small class="text-success d-block mt-1">
                                {{ item.product.stock }} dispon√≠veis
                            </small>
                        </div>

                        <!-- TOTAL ITEM -->
                        <div class="col-12 col-md-2 text-center text-md-end mt-2 mt-md-0">
                            <div class="small text-muted">Total</div>
                            <div class="fw-bold text-primary mb-2">
                                R$ {{ item.total_price|floatformat:2 }}
                            </div>

                            <button class="btn btn-sm btn-outline-danger remove-item"
                                    data-product="{{ item.product.id }}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>

                    </div>

                </div>
                {% endfor %}

            </div>

            <!-- RESUMO -->
            <div class="col-lg-4">
                <div class="cart-summary sticky-top">

                    <h5 class="fw-bold mb-4">
                        Resumo do Pedido
                    </h5>

                    <div class="d-flex justify-content-between mb-3">
                        <span>Subtotal</span>
                        <span>
                            R$ {{ total|floatformat:2 }}
                        </span>
                    </div>

                    <div class="d-flex justify-content-between mb-3">
                        <span>Frete</span>
                        <span class="text-success">
                            Calculado no checkout
                        </span>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="fw-bold">Total</span>
                        <span class="h4 fw-bold text-primary mb-0">
                            R$ {{ total|floatformat:2 }}
                        </span>
                    </div>

                    <form action="{% url 'orders:checkout' %}" method="get" style="display: inline;">
                        <button type="submit" class="btn btn-primary w-100 py-3 mb-3 fw-semibold">
                            <i class="fas fa-credit-card me-2"></i>Finalizar Pedido
                        </button>
                    </form>


                    <a href="{% url 'products:product_list' %}"
                       class="btn btn-outline-secondary w-100 py-3">
                        <i class="fas fa-arrow-left me-2"></i>
                        Continuar Comprando
                    </a>

                </div>
            </div>

        </div>
    </div>

    {% else %}

    <!-- CARRINHO VAZIO -->
    <div class="text-center py-5">

        <i class="fas fa-shopping-cart fa-5x text-muted mb-4"></i>

        <h3 class="fw-bold mb-3">
            Seu carrinho est√° vazio
        </h3>

        <p class="text-muted mb-4">
            Explore nosso cat√°logo premium e encontre produtos incr√≠veis.
        </p>

        <a href="{% url 'products:product_list' %}"
           class="btn btn-primary btn-lg px-5">
            Come√ßar Compras
        </a>

    </div>

    {% endif %}

</div>

<!-- AJAX SCRIPT -->
<script>
document.addEventListener('DOMContentLoaded', function() {

    document.querySelectorAll('.update-qty').forEach(input => {
        input.addEventListener('change', function() {
            fetch("{% url 'cart:update' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    product_id: this.dataset.product,
                    quantity: this.value
                })
            }).then(() => location.reload());
        });
    });

    document.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', function() {
            fetch("{% url 'cart:remove' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    product_id: this.dataset.product
                })
            }).then(() => location.reload());
        });
    });

});
</script>

{% endblock %}
